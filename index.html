<html>

<head>
    <title>COVID19 Graphs</title>
    <script type="module">
        import Highcharts from 'https://code.highcharts.com/es-modules/masters/highcharts.src.js';

        const recoveredColor = '#198c19';
        const confirmedColor = '#308fa4';
        const deathsColor = '#cc0000';

        let percentageChart;
        const onDataLineChart = (data, key) => {
            data = data[key]
            Highcharts.chart('container',
                {
                    title: {
                        text: `${key} COVID19 Cases`
                    },
                    chart: {
                        zoomType: 'xy'
                    },

                    yAxis: {
                        title: {
                            text: 'Cases'
                        }
                    },

                    tooltip: {
                        split: true
                    },

                    xAxis: {
                        type: 'datetime',
                        title: {
                            text: 'Date'
                        },
                        // labels: {
                        //     format: '%Y-%b-%e'
                        // },
                        labels: {
                            format: '{value:%Y-%m-%d}',
                        }
                        // dateTimeLabelFormats: {
                        //     day: "%e-%b-%y",
                        //     month: "%b-%y"
                        // }
                    },

                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle'
                    },

                    series: [{
                        name: 'Confirmed',
                        color: confirmedColor,
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.confirmed]
                        })
                    }, {
                        name: 'Recovered',
                        color: recoveredColor,
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.recovered]
                        })
                    }, {
                        name: 'Deaths',
                        color: deathsColor,
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.deaths]
                        })
                    }],

                    responsive: {
                        rules: [{
                            condition: {
                                maxWidth: 500
                            },
                            chartOptions: {
                                legend: {
                                    layout: 'horizontal',
                                    align: 'center',
                                    verticalAlign: 'bottom'
                                }
                            }
                        }]
                    }
                })
        };
        const onDataAggregateChart = (data) => {
                let aggData = Object.entries(data);
                aggData.sort(([k1, a], [k2, b]) => b[b.length - 1].confirmed - a[a.length - 1].confirmed);
                aggData = aggData.slice(0, 10);
                console.log(aggData);
                Highcharts.chart('allcountries',
                    {
                        title: {
                            text: `Top 10 Countries COVID19 Confirmed Cases`
                        },
                        chart: {
                            zoomType: 'xy'
                        },

                        yAxis: {
                            title: {
                                text: 'Cases'
                            }
                        },

                        tooltip: {
                            split: true
                        },

                        xAxis: {
                            type: 'datetime',
                            title: {
                                text: 'Date'
                            },
                            // labels: {
                            //     format: '%Y-%b-%e'
                            // },
                            labels: {
                                format: '{value:%Y-%m-%d}',
                            }
                            // dateTimeLabelFormats: {
                            //     day: "%e-%b-%y",
                            //     month: "%b-%y"
                            // }
                        },

                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'middle'
                        },

                        series: aggData.map(([key, value]) => ({
                            name: key,
                            data: value.map(item => {
                                var split = item.date.split('-');
                                return [Date.UTC(split[0], split[1] - 1, split[2]), item.confirmed]
                            })
                        })),

                        responsive: {
                            rules: [{
                                condition: {
                                    maxWidth: 500
                                },
                                chartOptions: {
                                    legend: {
                                        layout: 'horizontal',
                                        align: 'center',
                                        verticalAlign: 'bottom'
                                    }
                                }
                            }]
                        }
                    })
            };
        const onDataAggregateDeathsChart = (data) => {
                let aggData = Object.entries(data);
                aggData.sort(([k1, a], [k2, b]) => b[b.length - 1].deaths - a[a.length - 1].deaths);
                aggData = aggData.slice(0, 10);
                console.log(aggData);
                Highcharts.chart('allcountriesdeaths',
                    {
                        title: {
                            text: `Top 10 Countries COVID19 Deaths`
                        },
                        chart: {
                            zoomType: 'xy'
                        },

                        yAxis: {
                            title: {
                                text: 'Cases'
                            }
                        },

                        tooltip: {
                            split: true
                        },

                        xAxis: {
                            type: 'datetime',
                            title: {
                                text: 'Date'
                            },
                            // labels: {
                            //     format: '%Y-%b-%e'
                            // },
                            labels: {
                                format: '{value:%Y-%m-%d}',
                            }
                            // dateTimeLabelFormats: {
                            //     day: "%e-%b-%y",
                            //     month: "%b-%y"
                            // }
                        },

                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'middle'
                        },

                        series: aggData.map(([key, value]) => ({
                            name: key,
                            data: value.map(item => {
                                var split = item.date.split('-');
                                return [Date.UTC(split[0], split[1] - 1, split[2]), item.deaths]
                            })
                        })),

                        responsive: {
                            rules: [{
                                condition: {
                                    maxWidth: 500
                                },
                                chartOptions: {
                                    legend: {
                                        layout: 'horizontal',
                                        align: 'center',
                                        verticalAlign: 'bottom'
                                    }
                                }
                            }]
                        }
                    })
            };
        const onDataAggregateActiveChart = (data) => {
                let aggData = Object.entries(data);
                aggData.sort(([k1, a], [k2, b]) => (b[b.length - 1].confirmed - b[b.length - 1].recovered - b[b.length - 1].deaths) - (a[a.length - 1].confirmed - a[a.length - 1].recovered - a[a.length - 1].deaths));
                aggData = aggData.slice(0, 10);
                console.log(aggData);
                Highcharts.chart('allcountriesactive',
                    {
                        title: {
                            text: `Top 10 Countries COVID19 Active Cases`
                        },
                        subtitle: {
                            text: "Active = Confirmed - Recovered - Deaths"
                        },
                        chart: {
                            zoomType: 'xy'
                        },

                        yAxis: {
                            title: {
                                text: 'Cases'
                            }
                        },

                        tooltip: {
                            split: true
                        },

                        xAxis: {
                            type: 'datetime',
                            title: {
                                text: 'Date'
                            },
                            // labels: {
                            //     format: '%Y-%b-%e'
                            // },
                            labels: {
                                format: '{value:%Y-%m-%d}',
                            }
                            // dateTimeLabelFormats: {
                            //     day: "%e-%b-%y",
                            //     month: "%b-%y"
                            // }
                        },

                        legend: {
                            layout: 'vertical',
                            align: 'right',
                            verticalAlign: 'middle'
                        },

                        series: aggData.map(([key, value]) => ({
                            name: key,
                            data: value.map(item => {
                                var split = item.date.split('-');
                                return [Date.UTC(split[0], split[1] - 1, split[2]), item.confirmed - item.recovered - item.deaths]
                            })
                        })),

                        responsive: {
                            rules: [{
                                condition: {
                                    maxWidth: 500
                                },
                                chartOptions: {
                                    legend: {
                                        layout: 'horizontal',
                                        align: 'center',
                                        verticalAlign: 'bottom'
                                    }
                                }
                            }]
                        }
                    })
            };
        const onDataPercentageChart = (data, key) => {
            data = data[key];
            getPopulation(key).then(pop => {
                percentageChart = Highcharts.chart('percentage', {
                    chart: {
                        type: 'area',
                        zoomType: 'xy',
                        resetZoomButton: {
                            position: {
                                align: 'left'
                            }
                        }
                    },
                    title: {
                        text: `${key} Infected by population percentage`
                    },
                    subtitle: {
                        text: "Left-most point is when cases were first > 100"
                    },
                    xAxis: {
                        type: 'datetime',
                        title: {
                            text: 'Date'
                        },
                        // labels: {
                        //     format: '%Y-%b-%e'
                        // },
                        labels: {
                            format: '{value:%Y-%m-%d}',
                        }
                        // dateTimeLabelFormats: {
                        //     day: "%e-%b-%y",
                        //     month: "%b-%y"
                        // }
                    },
                    yAxis: {
                        labels: {
                            format: '{value}%'
                        },
                        title: {
                            enabled: false
                        }
                    },
                    tooltip: {
                        pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.percentage:.1f}%</b> ({point.y:,.0f})<br/>',
                        split: true
                    },
                    plotOptions: {
                        area: {
                            stacking: 'percent',
                            lineColor: '#ffffff',
                            lineWidth: 1,
                            marker: {
                                lineWidth: 1,
                                lineColor: '#ffffff'
                            },
                            accessibility: {
                                pointDescriptionFormatter: function (point) {
                                    function round(x) {
                                        return Math.round(x * 100) / 100;
                                    }
                                    return (point.index + 1) + ', ' + point.category + ', ' +
                                        point.y + ' millions, ' + round(point.percentage) + '%, ' +
                                        point.series.name;
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'Healthy',
                        color: confirmedColor,
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), pop - (item.confirmed - item.recovered - item.deaths) - item.recovered - item.deaths]
                        })
                    }, {
                        name: 'Active',
                        color: '#b55127',
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.confirmed - item.recovered - item.deaths]
                        })
                    }, {
                        name: 'Recovered',
                        color: recoveredColor,
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.recovered]
                        })
                    }, {
                        color: deathsColor,
                        name: 'Deaths',
                        data: data.map(item => {
                            var split = item.date.split('-');
                            return [Date.UTC(split[0], split[1] - 1, split[2]), item.deaths]
                        })
                    }]
                });
                const last = data[data.length - 1];
                let split = last.date.split('-');
                const lastDate = Date.UTC(split[0], split[1] - 1, split[2]);
                const firstOver100 = data.find(item => item.confirmed >= 100);
                split = firstOver100.date.split('-');
                const extremeDate = Date.UTC(split[0], split[1] - 1, split[2]);
                percentageChart.yAxis[0].setExtremes(0, 100 * (last.confirmed) / pop);
                percentageChart.xAxis[0].setExtremes(extremeDate, lastDate);
                percentageChart.showResetZoom();

            })
                .catch(err => {
                    if (percentageChart) {
                        percentageChart.destroy();
                    }
                });
        }
        const getPopulation = (key) =>
            getCountryCode(key).then(code =>
                fetch(`https://restcountries.eu/rest/v2/alpha/${code}?fields=population`)
                    .then(response => response.json())
                    .then(val => val.population));
        const getCountryCode = (key) =>
            fetch("https://sspeaks.github.io/covid19/countries.json")
                .then(response => response.json())
                .then(dat => dat[key].code);
        fetch("https://sspeaks.github.io/covid19/timeseries.json")
            .then(response => response.json())
            .then(dat => {
                const select = document.querySelector('#container2 select');
                Object.keys(dat).sort().forEach(key => select.append(new Option(key, key)));
                onDataLineChart(dat, "US");
                onDataPercentageChart(dat, "US");
                onDataAggregateChart(dat);
                onDataAggregateActiveChart(dat);
                onDataAggregateDeathsChart(dat);

                select.onchange = (val) => {
                    onDataLineChart(dat, val.target.value);
                    onDataPercentageChart(dat, val.target.value);
                }
            }
            ).catch((err) => {
                document.querySelector('#container').append(err);
                document.querySelector('#percentage').append(err);
            });
    </script>
</head>

<body>

    <div id="container"></div>
    <div id="percentage"></div>
    <div id="container2">
        <select>
            <option selected disabled hidden>Select a Country...</option>
        </select>
    </div>
    <div id="allcountries"></div>
    <div id="allcountriesactive"></div>
    <div id="allcountriesdeaths"></div>
    <p style="float: right">
        Data Source <a href="https://github.com/pomber/covid19">https://github.com/pomber/covid19</a>
    </p>

    <!-- <script src="https://unpkg.com/covid-charts/index.js"></script>
    <script>
      const chart = createChart(document.querySelector('#container2'), {
        country: "US",
        width: 400,
        height: 300
      });
    </script> -->
</body>

</html>